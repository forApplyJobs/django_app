{% extends 'base.html' %}

{% block title %}Preview Frame: {{ frame.name }} - Frame Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-0"><i class="fas fa-eye me-2"></i>Preview Frame:
            {{frame.name }}</h1>
        <p class="text-muted mb-0">Adjust coordinates and preview the result</p>
    </div>
    <a href="{% url 'frame_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to Frames
    </a>
</div>

<div class="row">
    <!-- Preview Canvas -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-desktop me-2"></i>Live
                    Preview</h5>
            </div>
            <div class="card-body text-center">
                <div id="preview-container"
                    class="position-relative d-inline-block border border-2 border-dashed"
                    style="user-select: none;">
                    <div class="position-relative d-inline-block">
                        <img id="frame-image" src="{{  frame.image.url }}"
                            alt="Frame" class="img-fluid"
                            style="max-width: 600px;">
                        {% if first_image %}
                        <div id="product-wrapper" class="position-absolute"
                            style="top: 0; left: 0; cursor: move; min-width: 20px; min-height: 20px;">
                            <img id="product-image" src="{{ first_image }}"
                                alt="Product"
                                style="width: 100%; height: 100%; opacity: 0.8; outline: 1px solid red; outline-offset: -1px; pointer-events: none;">
                            <!-- Resize handles -->
                            <div class="resize-handle resize-se"
                                style="position: absolute; bottom: -5px; right: -5px; width: 10px; height: 10px; background: red; cursor: se-resize; border-radius: 50%;"></div>
                            <div class="resize-handle resize-sw"
                                style="position: absolute; bottom: -5px; left: -5px; width: 10px; height: 10px; background: red; cursor: sw-resize; border-radius: 50%;"></div>
                            <div class="resize-handle resize-ne"
                                style="position: absolute; top: -5px; right: -5px; width: 10px; height: 10px; background: red; cursor: ne-resize; border-radius: 50%;"></div>
                            <div class="resize-handle resize-nw"
                                style="position: absolute; top: -5px; left: -5px; width: 10px; height: 10px; background: red; cursor: nw-resize; border-radius: 50%;"></div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Drag to move, use corner handles to resize, or adjust
                        coordinates manually.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="col-lg-4">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Coordinate
                    Settings</h5>
            </div>
            <div class="card-body">
                <form method="post" id="coordinates-form">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="x-input" class="form-label">
                                    <i class="fas fa-arrows-alt-h me-1"></i>X
                                    Position
                                </label>
                                <div class="input-group">
                                    <input type="number" id="x-input"
                                        class="form-control" value="0" min="0">
                                    <span class="input-group-text">px</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="y-input" class="form-label">
                                    <i class="fas fa-arrows-alt-v me-1"></i>Y
                                    Position
                                </label>
                                <div class="input-group">
                                    <input type="number" id="y-input"
                                        class="form-control" value="0" min="0">
                                    <span class="input-group-text">px</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="width-input" class="form-label">
                                    <i
                                        class="fas fa-arrows-alt-h me-1"></i>Width
                                </label>
                                <div class="input-group">
                                    <input type="number" id="width-input"
                                        class="form-control" value="100"
                                        min="1">
                                    <span class="input-group-text">px</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="height-input" class="form-label">
                                    <i
                                        class="fas fa-arrows-alt-v me-1"></i>Height
                                </label>
                                <div class="input-group">
                                    <input type="number" id="height-input"
                                        class="form-control" value="100"
                                        min="1">
                                    <span class="input-group-text">px</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="coordinates"
                        id="coordinates-hidden">

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-magic me-2"></i>Save & Generate
                            Images
                        </button>
                    </div>
                </form>

                <div class="alert alert-light mt-4">
                    <h6><i class="fas fa-lightbulb me-1"></i>Instructions:</h6>
                    <ul class="small mb-0">
                        <li>Adjust X, Y for position</li>
                        <li>Set Width, Height for size</li>
                        <li>Preview updates in real-time</li>
                        <li>Origin (0,0) is top-left corner</li>
                    </ul>
                </div>

                {% if frame.coordinates %}
                <div class="alert alert-info mt-3">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Current:</strong> X:{{ frame.coordinates.x }},
                        Y:{{ frame.coordinates.y }},
                        W:{{ frame.coordinates.width }}, H:{{
                        frame.coordinates.height }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const xInput = document.getElementById('x-input');
    const yInput = document.getElementById('y-input');
    const widthInput = document.getElementById('width-input');
    const heightInput = document.getElementById('height-input');
    const productImage = document.getElementById('product-image');
    const frameImage = document.getElementById('frame-image');
    const coordinatesHidden = document.getElementById('coordinates-hidden');
    const form = document.getElementById('coordinates-form');
    const productWrapper = document.getElementById('product-wrapper');
    const resizeHandles = document.querySelectorAll('.resize-handle');
    
    // Wait for frame image to load completely
    let frameImageLoaded = false;
    
    frameImage.onload = function() {
        frameImageLoaded = true;
        console.log('Frame image loaded:', frameImage.naturalWidth, 'x', frameImage.naturalHeight);
    };
    
    // If image is already cached/loaded
    if (frameImage.complete && frameImage.naturalWidth > 0) {
        frameImageLoaded = true;
        console.log('Frame image already loaded:', frameImage.naturalWidth, 'x', frameImage.naturalHeight);
    }
    
    // Load existing coordinates if any
    const existingCoords = {{ frame.coordinates|safe }};
    if (existingCoords && Object.keys(existingCoords).length > 0) {
        // If coordinates exist, they are already in backend scale, need to convert to frontend
        if (existingCoords.frontend) {
            // Use frontend coordinates if available
            xInput.value = existingCoords.frontend.x || 0;
            yInput.value = existingCoords.frontend.y || 0;
            widthInput.value = existingCoords.frontend.width || 100;
            heightInput.value = existingCoords.frontend.height || 100;
        } else {
            // Convert backend coordinates to frontend (reverse scaling)
            setTimeout(() => {
                if (frameImageLoaded) {
                    const scaling = getScalingFactors();
                    xInput.value = Math.round((existingCoords.x || 0) / scaling.scaleX);
                    yInput.value = Math.round((existingCoords.y || 0) / scaling.scaleY);
                    widthInput.value = Math.round((existingCoords.width || 100) / scaling.scaleX);
                    heightInput.value = Math.round((existingCoords.height || 100) / scaling.scaleY);
                    updatePreview();
                }
            }, 100);
        }
        updatePreview();
    } else {
        // İlk kez ekleniyor - frame'e fit et
        setTimeout(() => {
            if (frameImageLoaded) {
                fitToFrame();
            }
        }, 100);
    }
    
    // Frame'e fit etme fonksiyonu
    function fitToFrame() {
        const frameWidth = frameImage.clientWidth;
        const frameHeight = frameImage.clientHeight;
        
        // Frame'in %60'ını kaplasın (çok büyük olmasın)
        const targetWidth = Math.round(frameWidth * 0.6);
        const targetHeight = Math.round(frameHeight * 0.6);
        
        // Ortada konumlandır
        const centerX = Math.round((frameWidth - targetWidth) / 2);
        const centerY = Math.round((frameHeight - targetHeight) / 2);
        
        xInput.value = centerX;
        yInput.value = centerY;
        widthInput.value = targetWidth;
        heightInput.value = targetHeight;
        
        updatePreview();
        console.log('Auto-fitted to frame:', centerX, centerY, targetWidth, targetHeight);
    }
    
    // Boundary kontrolü fonksiyonu
    function constrainToFrame() {
        const frameWidth = frameImage.clientWidth;
        const frameHeight = frameImage.clientHeight;
        
        let x = parseInt(xInput.value) || 0;
        let y = parseInt(yInput.value) || 0;
        let width = parseInt(widthInput.value) || 100;
        let height = parseInt(heightInput.value) || 100;
        
        // Minimum boyutlar
        width = Math.max(20, width);
        height = Math.max(20, height);
        
        // Frame sınırları içinde kalmasını sağla
        x = Math.max(0, Math.min(x, frameWidth - width));
        y = Math.max(0, Math.min(y, frameHeight - height));
        
        // Maximum boyutlar (frame'den büyük olamaz)
        width = Math.min(width, frameWidth - x);
        height = Math.min(height, frameHeight - y);
        
        // Input'ları güncelle
        xInput.value = x;
        yInput.value = y;
        widthInput.value = width;
        heightInput.value = height;
        
        return { x, y, width, height };
    }
    
    // Calculate scaling factors with better error handling
    function getScalingFactors() {
        if (!frameImageLoaded || frameImage.naturalWidth === 0) {
            console.warn('Frame image not loaded yet, using 1:1 scaling');
            return {
                scaleX: 1,
                scaleY: 1,
                originalWidth: frameImage.clientWidth,
                originalHeight: frameImage.clientHeight,
                displayedWidth: frameImage.clientWidth,
                displayedHeight: frameImage.clientHeight
            };
        }
        
        const displayedWidth = frameImage.clientWidth;
        const displayedHeight = frameImage.clientHeight;
        const originalWidth = frameImage.naturalWidth;
        const originalHeight = frameImage.naturalHeight;
        
        return {
            scaleX: originalWidth / displayedWidth,
            scaleY: originalHeight / displayedHeight,
            originalWidth: originalWidth,
            originalHeight: originalHeight,
            displayedWidth: displayedWidth,
            displayedHeight: displayedHeight
        };
    }
    
    function updatePreview() {
        if (productWrapper) {
            const x = parseInt(xInput.value) || 0;
            const y = parseInt(yInput.value) || 0;
            const width = parseInt(widthInput.value) || 100;
            const height = parseInt(heightInput.value) || 100;
            
            // Product wrapper frame'a göre absolute pozisyonlanıyor
            productWrapper.style.left = x + 'px';
            productWrapper.style.top = y + 'px';
            productWrapper.style.width = width + 'px';
            productWrapper.style.height = height + 'px';
            
            console.log('Product position updated:', x, y, width, height);
        }
    }
    
    // Update preview when inputs change
    [xInput, yInput, widthInput, heightInput].forEach(input => {
        input.addEventListener('input', function() {
            constrainToFrame();
            updatePreview();
        });
        
        // Add visual feedback
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('border-primary');
        });
        
        input.addEventListener('blur', function() {
            this.parentElement.classList.remove('border-primary');
        });
    });
    
    // Set coordinates JSON before form submission
    form.addEventListener('submit', function(e) {
        // Wait a bit to ensure frame is loaded
        if (!frameImageLoaded) {
            e.preventDefault();
            alert('Please wait for the frame image to load completely.');
            return false;
        }
        
        const scaling = getScalingFactors();
        
        // Frontend coordinates (as displayed)
        const frontendX = parseInt(xInput.value) || 0;
        const frontendY = parseInt(yInput.value) || 0;
        const frontendWidth = parseInt(widthInput.value) || 100;
        const frontendHeight = parseInt(heightInput.value) || 100;
        
        // Convert to backend coordinates (original scale) with precise rounding
        const backendX = Math.round(frontendX * scaling.scaleX);
        const backendY = Math.round(frontendY * scaling.scaleY);
        const backendWidth = Math.round(frontendWidth * scaling.scaleX);
        const backendHeight = Math.round(frontendHeight * scaling.scaleY);
        
        const coordinates = {
            x: backendX,
            y: backendY,
            width: backendWidth,
            height: backendHeight,
            // Keep frontend coordinates for future reference
            frontend: {
                x: frontendX,
                y: frontendY,
                width: frontendWidth,
                height: frontendHeight
            },
            scaling: {
                scaleX: Math.round(scaling.scaleX * 1000) / 1000, // 3 decimal precision
                scaleY: Math.round(scaling.scaleY * 1000) / 1000,
                originalSize: `${scaling.originalWidth}x${scaling.originalHeight}`,
                displayedSize: `${scaling.displayedWidth}x${scaling.displayedHeight}`
            }
        };
        
        coordinatesHidden.value = JSON.stringify(coordinates);
        
        console.log('Frontend coordinates:', frontendX, frontendY, frontendWidth, frontendHeight);
        console.log('Backend coordinates:', backendX, backendY, backendWidth, backendHeight);
        console.log('Scaling factors:', scaling.scaleX, scaling.scaleY);
        console.log('Frame natural size:', frameImage.naturalWidth, 'x', frameImage.naturalHeight);
        console.log('Frame displayed size:', frameImage.clientWidth, 'x', frameImage.clientHeight);
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        submitBtn.disabled = true;
    });
    
    // Drag and resize functionality
    let isDragging = false;
    let isResizing = false;
    let startX, startY, startLeft, startTop, startWidth, startHeight;
    let currentHandle;
    
    if (productWrapper) {
        productWrapper.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('resize-handle')) {
                isResizing = true;
                currentHandle = e.target;
            } else {
                isDragging = true;
            }
            
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(productWrapper.style.left) || 0;
            startTop = parseInt(productWrapper.style.top) || 0;
            startWidth = parseInt(productWrapper.style.width) || 100;
            startHeight = parseInt(productWrapper.style.height) || 100;
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            e.preventDefault();
        });
    }
    
    function onMouseMove(e) {
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        
        if (isDragging) {
            const newLeft = startLeft + dx;
            const newTop = startTop + dy;
            
            productWrapper.style.left = newLeft + 'px';
            productWrapper.style.top = newTop + 'px';
            
            updateInputsFromWrapper();
            
        } else if (isResizing) {
            let newWidth = startWidth;
            let newHeight = startHeight;
            let newLeft = startLeft;
            let newTop = startTop;
            
            if (currentHandle.classList.contains('resize-se')) {
                newWidth = startWidth + dx;
                newHeight = startHeight + dy;
            } else if (currentHandle.classList.contains('resize-sw')) {
                newWidth = startWidth - dx;
                newHeight = startHeight + dy;
                newLeft = startLeft + dx;
            } else if (currentHandle.classList.contains('resize-ne')) {
                newWidth = startWidth + dx;
                newHeight = startHeight - dy;
                newTop = startTop + dy;
            } else if (currentHandle.classList.contains('resize-nw')) {
                newWidth = startWidth - dx;
                newHeight = startHeight - dy;
                newLeft = startLeft + dx;
                newTop = startTop + dy;
            }
            
            // Apply new values
            productWrapper.style.width = newWidth + 'px';
            productWrapper.style.height = newHeight + 'px';
            productWrapper.style.left = newLeft + 'px';
            productWrapper.style.top = newTop + 'px';
            
            updateInputsFromWrapper();
        }
    }
    
    function onMouseUp() {
        isDragging = false;
        isResizing = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        
        // Final constraint check
        constrainToFrame();
        updatePreview();
    }
    
    function updateInputsFromWrapper() {
        const left = parseInt(productWrapper.style.left) || 0;
        const top = parseInt(productWrapper.style.top) || 0;
        const width = parseInt(productWrapper.style.width) || 100;
        const height = parseInt(productWrapper.style.height) || 100;
        
        xInput.value = left;
        yInput.value = top;
        widthInput.value = width;
        heightInput.value = height;
        
        // Real-time constraint
        constrainToFrame();
    }
});
</script>
{% endblock %}